name: CI/CD Pipeline for Claude Code + Gemini Dual AI Environment

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  # Добавляем запуск по расписанию для ночных проверок
  schedule:
    - cron: '0 2 * * *'  # Каждый день в 2 AM UTC

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Тестирование сборки Docker образа
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    # Добавляем условие для пропуска если нет изменений в Docker файлах
    if: |
      github.event_name == 'release' ||
      github.event_name == 'schedule' ||
      contains(github.event.head_commit.modified, 'Dockerfile') ||
      contains(github.event.head_commit.modified, 'package') ||
      contains(github.event.head_commit.modified, 'entrypoint.sh')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-

    - name: Build and test Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: test-image:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GEMINI_VERSION=latest
          CLAUDE_VERSION=latest

    - name: Test container functionality
      run: |
        echo "Testing basic container functionality..."

        # Тест базового запуска
        docker run --rm test-image --version || echo "Version check failed (expected for test)"

        # Тест доступности утилит
        docker run --rm --entrypoint="" test-image which node
        docker run --rm --entrypoint="" test-image which npm
        docker run --rm --entrypoint="" test-image which git
        docker run --rm --entrypoint="" test-image which ssh

        # Тест Node.js версии
        docker run --rm --entrypoint="" test-image node --version

        echo "✅ Container functionality tests passed"

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GEMINI_VERSION=latest
          CLAUDE_VERSION=latest

  # Тестирование скриптов установки
  test-scripts:
    runs-on: macos-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test install.sh script
      run: |
        echo "Testing install.sh script..."

        # Проверка синтаксиса
        bash -n install.sh

        # Тест help функциональности (без реальной установки)
        if grep -q "help" install.sh; then
          echo "✅ install.sh contains help functionality"
        fi

        echo "✅ install.sh script validation passed"

    - name: Test ai-assistant.zsh script
      run: |
        echo "Testing ai-assistant.zsh script..."

        # Проверка синтаксиса
        zsh -n ai-assistant.zsh

        # Проверка наличия ключевых функций
        if grep -q "function gemini" ai-assistant.zsh && \
           grep -q "function claude" ai-assistant.zsh && \
           grep -q "function aic" ai-assistant.zsh && \
           grep -q "function cic" ai-assistant.zsh; then
          echo "✅ All required functions found"
        else
          echo "❌ Missing required functions"
          exit 1
        fi

        echo "✅ ai-assistant.zsh script validation passed"

  # Тестирование безопасности
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: test-image:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        category: container-scan

  # Тестирование документации
  docs-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test README.md
      run: |
        echo "Testing README.md..."

        # Проверка наличия ключевых секций
        if grep -q "## Quick Start" README.md && \
           grep -q "## Установка" README.md && \
           grep -q "## Архитектура" README.md; then
          echo "✅ README.md contains required sections"
        else
          echo "❌ README.md missing required sections"
          exit 1
        fi

        # Проверка валидности Markdown
        if command -v markdownlint &> /dev/null; then
          markdownlint README.md || echo "⚠️ Markdown linting issues found"
        fi

        echo "✅ Documentation validation passed"

  # Публикация релиза
  release:
    needs: [build-test, test-scripts, security-scan, docs-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate release notes
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        files: |
          install.sh
          README.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Docker Hub description
      if: github.event_name == 'release'
      run: |
        # Здесь можно добавить логику для обновления описания в Docker Hub
        echo "Release published successfully"
