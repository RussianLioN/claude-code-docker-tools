# PROJECT_ARCHITECTURE.md

> **๐๏ธ ะญัะตะผะตัะฝะฐั Dual AI Environment Architecture**
> *ะญะบัะฟะตััะฝะฐั ะฐััะธัะตะบัััะฐ ะฝะฐ ะพัะฝะพะฒะต ััะตะผะตัะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ ะธ ะฟัะพะฒะตัะตะฝะฝัั ะฟะฐััะตัะฝะพะฒ*

**๐ Navigation**: [โ Back to CLAUDE.md](./CLAUDE.md)

## ๐ Overview

ะะพะบัะผะตะฝั ะพะฟะธััะฒะฐะตั ะฟะตัะตัะฐะฑะพัะฐะฝะฝัั ะฐััะธัะตะบัััั Dual AI Assistant Environment ะฝะฐ ะพัะฝะพะฒะต **ัะบัะฟะตััะฝะพะณะพ ะฟะพะดัะพะดะฐ** ั ััะตะผะตัะฝัะผะธ ะบะพะฝัะตะนะฝะตัะฐะผะธ. ะ ะพัะปะธัะธะต ะพั ะฟัะตะดัะดััะตะน ะฒะตััะธะธ ั ะฟะตััะธััะตะฝัะฝัะผะธ ะบะพะฝัะตะนะฝะตัะฐะผะธ, ะฝะพะฒะฐั ะฐััะธัะตะบัััะฐ ัะปะตะดัะตั ะฟัะพะฒะตัะตะฝะฝัะผ ะฟะฐััะตัะฝะฐะผ ะธะท `old-scripts/gemini.zsh`.

## ๐ฏ ะะปััะตะฒะพะน ะััะธัะตะบัััะฝัะน ะัะธะฝัะธะฟ

### ะญัะตะผะตัะฝัะต ะะพะฝัะตะนะฝะตัั vs ะะตััะธััะตะฝัะฝัะต

**โ ะกัะฐััะน ะฟะพะดัะพะด (ะฟัะพะฑะปะตะผะฝัะน)**:
- ะะตััะธััะตะฝัะฝัะต ะบะพะฝัะตะนะฝะตัั ั ัะปะพะถะฝัะผ lifecycle management
- State tracking, health monitoring, auto-recovery
- ะะธะผะธัั ะบะพะฝัะตะนะฝะตัะพะฒ, ะฟัะพะฑะปะตะผั ั ะพัะธััะบะพะน
- ะกะปะพะถะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั ัะพััะพัะฝะธั

**โ ะะพะฒัะน ะฟะพะดัะพะด (ัะบัะฟะตััะฝัะน)**:
- ะญัะตะผะตัะฝัะต ะบะพะฝัะตะนะฝะตัั ั `--rm`
- ะะฐะฟััะบ ะธ ะทะฐะฑัะฒะฐะฝะธะต ะดะปั ะบะฐะถะดะพะน ะพะฟะตัะฐัะธะธ
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ
- ะัะพััะฐั ะธ ะฝะฐะดะตะถะฝะฐั ะผะพะดะตะปั

## ๐๏ธ Core Architecture

### High-Level Design

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    macOS Host System                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ           ai-assistant.zsh (Shell Wrapper)         โ โ โ
โ  โ  โโ gemini() โ Docker --rm (Ephemeral)            โ โ โ
โ  โ  โโ claude() โ Docker --rm (Ephemeral)            โ โ โ
โ  โ  โโ aic() / cic() (AI Commits)                     โ โ โ
โ  โ  โโ gexec() (System Commands)                      โ โ โ
โ  โ  โโ ai-session-manager.sh (Legacy Support)        โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                    Docker Runtime                       โ
โ              (ะญัะตะผะตัะฝัะต ะบะพะฝัะตะนะฝะตัั --rm)                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ            claude-code-tools Container              โ โ โ
โ  โ  โโ entrypoint.sh (Mode Detection)                 โ โ โ
โ  โ  โโ Node.js Runtime                                โ โ โ
โ  โ  โโ @google/gemini-cli                             โ โ โ
โ  โ  โโ @anthropic-ai/claude-cli                       โ โ โ
โ  โ  โโ System Utilities                               โ โ โ
โ  โ         โ ะะฐะฟััะบะฐะตััั ะดะปั ะบะฐะถะดะพะน ะบะพะผะฐะฝะดั             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                    Volume Mounts (ะฒัะตะผะตะฝะฝัะต)
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                Host File System                        โ
โ  โโ Project Directory (/app/<project>)                โ
โ  โโ Configuration (~/.docker-ai-config/)              โ
โ  โโ Project State (.gemini-state/.ai-state/)         โ
โ  โโ Session Registry (~/.ai-sessions/)                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Component Details

#### 1. Shell Wrapper (ai-assistant.zsh)

**Purpose**: ะฆะตะฝััะฐะปัะฝะฐั ัะพัะบะฐ ะพัะบะตัััะฐัะธะธ AI ะพะฟะตัะฐัะธะน

**ะญะบัะฟะตััะฝัะต ััะฝะบัะธะธ**:
```bash
# ะัะฝะพะฒะฝัะต AI ััะฝะบัะธะธ (ัะบัะฟะตััะฝัะน ะฟะฐััะตัะฝ)
gemini()      # Docker run --rm gemini-cli "$@"
claude()      # Docker run --rm claude-cli "$@"

# AI-ะพะฟะตัะฐัะธะธ (ัะบัะฟะตััะฝัะน ะฟะฐััะตัะฝ)
aic()         # Docker run --rm gemini-cli commit
cic()         # Docker run --rm claude-cli commit

# ะกะธััะตะผะฝัะต ะพะฟะตัะฐัะธะธ (ัะบัะฟะตััะฝัะน ะฟะฐััะตัะฝ)
gexec()       # Docker run --rm <command>
ai-mode()     # ะะตัะตะบะปััะตะฝะธะต AI ัะตะถะธะผะพะฒ
```

**ะญะบัะฟะตััะฝัะต ะฟะฐััะตัะฝั**:
- **Ephemeral Pattern**: ะะฐะถะดัะน ะฒัะทะพะฒ = ะฝะพะฒัะน ะบะพะฝัะตะนะฝะตั ั `--rm`
- **Sync-In/Sync-Out**: ะะพะฝัะธะณััะฐัะธั ัะธะฝััะพะฝะธะทะธััะตััั ะฟัะธ ะทะฐะฟััะบะต/ะทะฐะฒะตััะตะฝะธะธ
- **Zero Trust**: ะกะตะบัะตัั ะฝะธะบะพะณะดะฐ ะฝะต ะฟะพะบะธะดะฐัั ัะพัั
- **Smart Detection**: ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต project root

#### 2. Container Runtime (ะญะบัะฟะตััะฝัะน ะฟะพะดัะพะด)

**Base Image**: `node:22-alpine`

**ะญะบัะฟะตััะฝะฐั ะบะพะฝัะธะณััะฐัะธั**:
```bash
docker run --rm \
  --network host \
  -e GOOGLE_CLOUD_PROJECT=gemini-cli-auth-478707 \
  -e SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock \
  -v /run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock \
  -v "${SSH_KNOWN_HOSTS}":/root/.ssh/known_hosts \
  -v "${SSH_CONFIG_CLEAN}":/root/.ssh/config \
  -v "${GIT_CONFIG}":/root/.gitconfig \
  -v "${GH_CONFIG_DIR}":/root/.config/gh \
  -w "${CONTAINER_WORKDIR}" \
  -v "${TARGET_DIR}":"${CONTAINER_BASE_DIR}" \
  -v "${STATE_DIR}":/root/.gemini \
  claude-code-tools "$@"
```

**ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ ัะบัะฟะตััะฝะพะณะพ ะฟะพะดัะพะดะฐ**:
- `--rm`: ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ะบะพะฝัะตะนะฝะตัะฐ
- `--network host`: ะะฟัะธะผะฐะปัะฝะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- **Adaptive Workspace**: ะะพะฝัะธัะพะฒะฐะฝะธะต ะฒ `/workspace` ะดะปั ัะธัััั ะฟััะตะน
- **Global Auth**: ะะดะธะฝะพะต ััะฐะฝะธะปะธัะต ะฐะฒัะพัะธะทะฐัะธะธ ะดะปั ะฒัะตั ะฟัะพะตะบัะพะฒ
- SSH agent forwarding ะดะปั ะฐััะตะฝัะธัะธะบะฐัะธะธ

#### 3. Configuration Synchronization (Global-First)

**Global State Pattern**:
```bash
# Auth ะฒัะตะณะดะฐ ะฑะตัะตััั ะธะท ะณะปะพะฑะฐะปัะฝะพะณะพ ััะฐะฝะธะปะธัะฐ
export STATE_DIR="$DOCKER_AI_CONFIG_HOME/global_state"
export CLAUDE_STATE_DIR="$STATE_DIR/claude_config"

# Sync-In (ะดะพ ะทะฐะฟััะบะฐ)
cp "$GLOBAL_AUTH" "$STATE_DIR/google_accounts.json"

# Sync-Out (ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั)
# Claude ัะฐะผ ะพะฑะฝะพะฒะปัะตั ัะฐะนะปั ะฒ ะฟัะธะผะพะฝัะธัะพะฒะฐะฝะฝะพะผ volume
```

#### 4. Native Mode (Hybrid Architecture)

**ะคะปะฐะณ `--native`**:
ะะพะทะฒะพะปัะตั ะทะฐะฟััะบะฐัั ะปะพะบะฐะปัะฝัั ะฒะตััะธั Claude (npm) ะฒะผะตััะพ Docker-ะบะพะฝัะตะนะฝะตัะฐ.
- **ะะทะพะปััะธั**: ะัะฟะพะปัะทัะตั ัะพััะพะฒะพะต ะพะบััะถะตะฝะธะต (Node.js, ะฐะฒัะพัะธะทะฐัะธั ะฒ `~/.claude`).
- **Use Case**: ะะปั ะทะฐะดะฐั, ััะตะฑัััะธั ะฟััะผะพะณะพ ะดะพัััะฟะฐ ะบ ัะปะพะถะฝัะผ ะปะพะบะฐะปัะฝัะผ ะธะฝััััะผะตะฝัะฐะผ ะธะปะธ ะบะพะณะดะฐ Docker ะฝะตะดะพัััะฟะตะฝ.
- **ะะฒัะพัะธะทะฐัะธั**: ะะฐะทะดะตะปัะฝะฐั (Docker Auth != Native Auth).

## ๐ง Technical Implementation

### Directory Structure (ะะฑะฝะพะฒะปะตะฝะฝะฐั)

```
claude-code-docker-tools/
โโโ ai-assistant.zsh                # ะัะฝะพะฒะฝะพะน wrapper (ัะบัะฟะตััะฝัะน ะฟะฐััะตัะฝ)
โโโ Dockerfile                      # ะะฟัะตะดะตะปะตะฝะธะต ะบะพะฝัะตะนะฝะตัะฐ
โโโ entrypoint.sh                   # Runtime router
โโโ install.sh                      # Setup script
โโโ scripts/
โ   โโโ ai-session-manager.sh       # Legacy support (ะพะฟัะธะพะฝะฐะปัะฝะพ)
โ   โโโ docker-utils.sh             # Docker utilities
โโโ old-scripts/
โ   โโโ gemini.zsh                  # ะญัะฐะปะพะฝะฝัะน ัะบัะฟะตััะฝัะน ะบะพะด
โโโ claude-config.json              # Claude configuration
โโโ CLAUDE.md                       # Central AI instructions
โโโ AI_SYSTEM_INSTRUCTIONS.md       # Testing principles
โโโ GIT_WORKFLOWS.md                # Git operations guide
โโโ docs/
    โโโ PROJECT_ARCHITECTURE.md     # ะญัะฐ ะฐััะธัะตะบัััะฐ
    โโโ EPHEMERAL_DESIGN.md         # ะะตัะฐะปัะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะฟะฐััะตัะฝะพะฒ
```

### Configuration Management (ะญะบัะฟะตััะฝัะน ะฟะพะดัะพะด)

**Global Configuration** (`~/.docker-gemini-config/` ะธะปะธ `~/.docker-ai-config/`):
```
โโโ google_accounts.json           # OAuth ัะพะบะตะฝั
โโโ settings.json                  # Gemini ะฝะฐัััะพะนะบะธ
โโโ claude_config.json             # Claude ะฝะฐัััะพะนะบะธ
โโโ gh_config/                     # GitHub CLI ะบะพะฝัะธะณััะฐัะธั
โโโ global_state/                  # ะะปะพะฑะฐะปัะฝะพะต ัะพััะพัะฝะธะต ะดะปั non-git ะฟัะพะตะบัะพะฒ
```

**Project State** (`<project>/.gemini-state/` ะธะปะธ `<project>/.ai-state/`):
```
โโโ google_accounts.json           # ะัะพะตะบั-specific ะฐััะตะฝัะธัะธะบะฐัะธั
โโโ settings.json                  # ะัะพะตะบั-specific ะฝะฐัััะพะนะบะธ
โโโ ssh_config_clean               # ะัะธัะตะฝะฝัะน SSH ะบะพะฝัะธะณ
```

### Security Architecture (ะญะบัะฟะตััะฝัะน ะฟะฐััะตัะฝ)

**Zero Trust Implementation**:
- ะกะตะบัะตัั ะฝะธะบะพะณะดะฐ ะฝะต ะฟะพะบะธะดะฐัั ะดะธัะบ ัะพััะฐ
- SSH agent forwarding (ะฝะต ะบะปััะธ)
- ะะทะพะปะธัะพะฒะฐะฝะฝะฐั ััะตะดะฐ ะฒัะฟะพะปะฝะตะฝะธั ะบะพะฝัะตะนะฝะตัะฐ
- ะะฒัะพะผะฐัะธัะตัะบะธะน .gitignore ะดะปั ัะพััะพัะฝะธั

**SSH Sanitization (ัะบัะฟะตััะฝัะน ะฟะพะดัะพะด)**:
```bash
# ะฃะดะฐะปัะตััั ะธะท SSH ะบะพะฝัะธะณะฐ ะดะปั ัะพะฒะผะตััะธะผะพััะธ ั ะบะพะฝัะตะนะฝะตัะพะผ
grep -vE "UseKeychain|AddKeysToAgent|IdentityFile|IdentitiesOnly" "$SSH_CONFIG_SRC" > "$SSH_CONFIG_CLEAN"
```

## ๐ Data Flows (ะญะบัะฟะตััะฝัะต ะฟะฐััะตัะฝั)

### AI Session Flow (ะญัะตะผะตัะฝัะน)

```mermaid
sequenceDiagram
    participant User
    participant Shell
    participant Config
    participant Docker
    participant Container

    User->>Shell: gemini (ะธะปะธ claude)
    Shell->>Shell: ensure_docker_running()
    Shell->>Shell: ensure_ssh_loaded()
    Shell->>Config: sync_in_configs()
    Shell->>Docker: docker run --rm claude-code-tools
    Docker->>Container: ะญัะตะผะตัะฝัะน ะทะฐะฟััะบ
    Container->>User: AI ะธะฝัะตััะตะนั
    User->>Container: ะะฐะฒะตััะตะฝะธะต ัะตััะธะธ
    Container->>Docker: ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ (--rm)
    Config->>Config: sync_out_configs()
```

### Configuration Sync Flow (ะญะบัะฟะตััะฝัะน)

```mermaid
flowchart TD
    A[Global Config] --> B[Sync In]
    B --> C[Project State]
    C --> D[Container Mount]
    D --> E[Ephemeral Runtime]
    E --> F[Container Cleanup --rm]
    F --> G[Sync Out]
    G --> H[Updated Global]

    I[SSH Config] --> J[Sanitization]
    J --> K[Clean Config]
    K --> C
```

## ๐ Performance Considerations (ะญะบัะฟะตััะฝัะน ะฟะพะดัะพะด)

### Container Optimization (ะญะบัะฟะตััะฝัะน)

**Runtime Optimization**:
- `--rm`: ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ัะตััััะพะฒ
- `--network host`: ะะฐะบัะธะผะฐะปัะฝะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- ะะธะฝะธะผะฐะปัะฝัะต volume mounts: ัะพะปัะบะพ ะฝะตะพะฑัะพะดะธะผัะต
- ะญัะตะผะตัะฝะพััั = ะฝะตั ะฝะฐะบะพะฟะปะตะฝะธั ะผััะพัะฐ

**Resource Management**:
- ะะธะบะฐะบะธั ะฟัะพะฑะปะตะผ ั ะปะธะผะธัะฐะผะธ ะบะพะฝัะตะนะฝะตัะพะฒ
- ะะฒัะพะผะฐัะธัะตัะบะฐั ัะฑะพัะบะฐ ะผััะพัะฐ Docker
- ะะพััะพัะฝะฝะพะต ะพัะฒะพะฑะพะถะดะตะฝะธะต ัะตััััะพะฒ
- ะัะตะดัะบะฐะทัะตะผะพะต ะฟะพััะตะฑะปะตะฝะธะต ะฟะฐะผััะธ

### Session Management (ะฃะฟัะพัะตะฝะฝะพะต)

**ะญัะตะผะตัะฝะฐั ะฐััะธัะตะบัััะฐ**:
- ะะธะบะฐะบะพะณะพ health monitoring
- ะะธะบะฐะบะพะณะพ state tracking
- ะะธะบะฐะบะพะณะพ auto-recovery
- ะัะพััะพัะฐ ะธ ะฝะฐะดะตะถะฝะพััั

## ๐ Migration from Persistent to Ephemeral

### Changes Required

**1. ai-assistant.zsh**:
```bash
# ะกัะฐััะน ะฟะพะดัะพะด (ัะดะฐะปะธัั)
# docker run -d --name persistent-container

# ะะพะฒัะน ะฟะพะดัะพะด (ัะตะฐะปะธะทะพะฒะฐัั)
docker run --rm claude-code-tools "$@"
```

**2. ai-session-manager.sh**:
```bash
# ะะฟัะธะพะฝะฐะปัะฝะพ: legacy support
# ะะปะธ ะฟะพะปะฝะพะต ัะดะฐะปะตะฝะธะต ะฒ ะฟะพะปัะทั ะฟัะพัััั wrapper ััะฝะบัะธะน
```

**3. Configuration**:
- ะฃะฑัะฐัั persistent tracking
- ะฃะฟัะพััะธัั state management
- ะัะฟะพะปัะทะพะฒะฐัั ัะบัะฟะตััะฝัะต ะฟะฐััะตัะฝั ะธะท old-scripts/gemini.zsh

## ๐ฎ Future Enhancements (ะญะบัะฟะตััะฝัะน ะฟะพะดัะพะด)

### Planned Features

1. **Enhanced AI Mode Detection**
   - ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ะฟัะพะตะบัะฐ
   - ะะพะฝัะตะบััะฝัะต ะฟะพะดัะบะฐะทะบะธ ะดะปั ัะฐะทะฝัั ัะทัะบะพะฒ
   - ะฃะผะฝัะต ะฝะฐัััะพะนะบะธ ะฟะพ ัะผะพะปัะฐะฝะธั

2. **Configuration Profiles**
   - ะัะพัะธะปะธ ะดะปั ัะฐะทะฝัั ัะธะฟะพะฒ ะฟัะพะตะบัะพะฒ
   - Team-specific ะบะพะฝัะธะณััะฐัะธะธ
   - Environment-specific ะฝะฐัััะพะนะบะธ

3. **Advanced Tool Integration**
   - ะะฝัะตะณัะฐัะธั ั development tools
   - Custom AI agents
   - Workflow automation

### Scalability Considerations (ะญะบัะฟะตััะฝัะน)

**ะขะตะบััะธะต ะฟัะตะธะผััะตััะฒะฐ**:
- ะะธะบะฐะบะธั ะฟัะพะฑะปะตะผ ั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะตะผ (ััะตะผะตัะฝะพััั)
- ะัะพััะพัะฐ ะดะตะฟะปะพั
- ะัะตะดัะบะฐะทัะตะผะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- ะะธะฝะธะผะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั ะบ ัะตััััะฐะผ

**ะัะดััะธะต ัะปัััะตะฝะธั**:
- Batch operations ะดะปั ะผะฝะพะถะตััะฒะตะฝะฝัั ะบะพะผะฐะฝะด
- ะััะธัะพะฒะฐะฝะธะต ะบะพะฝัะธะณััะฐัะธะน
- ะะฐัะฐะปะปะตะปัะฝัะต ะพะฟะตัะฐัะธะธ

---

## ๐ท๏ธ Architecture Tags

```
Type: EPHEMERAL_ARCHITECTURE
Scope: EXPERT_PATTERN_BASED
Version: 3.0 (Ephemeral Redesign)
Components: 5 (ัะฟัะพัะตะฝะพ ั 7)
Patterns: 3 (Ephemeral, Sync-In/Out, Zero Trust)
Security_Level: Zero_Trust
Approach: Expert_Proven
Last_Updated: 2025-12-11
Based_On: old-scripts/gemini.zsh expert patterns
```