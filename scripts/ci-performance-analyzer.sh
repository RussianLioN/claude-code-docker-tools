#!/bin/bash
# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ CI/CD

set -euo pipefail

echo "üöÄ –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ CI/CD pipeline..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞
echo "üìä –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞..."
if command -v docker &> /dev/null; then
    start_time=$(date +%s)

    # –≠–º—É–ª—è—Ü–∏—è —Å–±–æ—Ä–∫–∏ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ push)
    docker build -t ci-test-image . --no-cache || {
        echo "‚ö†Ô∏è –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑..."
    }

    end_time=$(date +%s)
    build_time=$((end_time - start_time))
    echo "‚è±Ô∏è –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏: ${build_time} —Å–µ–∫—É–Ω–¥"

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    if [ $build_time -gt 300 ]; then
        echo "üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–±–æ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ:"
        echo "   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é Dockerfile (–º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è —Å–±–æ—Ä–∫–∞)"
        echo "   - –£–ª—É—á—à–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–µ–≤"
        echo "   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ .dockerignore"
    fi

    # –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
    docker rmi ci-test-image 2>/dev/null || true
fi

# –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üì¶ –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
repo_size=$(du -sh . | cut -f1)
echo "üìä –†–∞–∑–º–µ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: $repo_size"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –ü–æ–∏—Å–∫ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>10MB)..."
find . -type f -size +10M -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
    echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª: $file ($(du -h "$file" | cut -f1))"
done

# –ê–Ω–∞–ª–∏–∑ CI/CD –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
echo "‚öôÔ∏è –ê–Ω–∞–ª–∏–∑ CI/CD –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ jobs –≤ workflows
total_jobs=0
for workflow in .github/workflows/*.yml; do
    if [ -f "$workflow" ]; then
        jobs=$(grep -c "^[[:space:]]*[a-zA-Z0-9_-]*:" "$workflow" | head -1)
        total_jobs=$((total_jobs + jobs))
        echo "üìã $(basename "$workflow"): $jobs jobs"
    fi
done

echo "üìä –í—Å–µ–≥–æ jobs: $total_jobs"

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ CI/CD
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ CI/CD:"
echo "   1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
echo "   2. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑—É–π—Ç–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–¥–∞—á–∏"
echo "   3. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ Docker —Å–ª–æ–∏"
echo "   4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Ç—Ä–∏—á–Ω—ã–µ —Å–±–æ—Ä–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π"
echo "   5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö"

echo "‚úÖ –ê–Ω–∞–ª–∏–∑ CI/CD pipeline –∑–∞–≤–µ—Ä—à–µ–Ω"
